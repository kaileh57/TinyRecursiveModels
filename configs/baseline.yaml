# JAX/Flax Training Configuration for TRM
# Baseline configuration for TPU v4-64 deployment

# Architecture configuration
arch:
  name: recursive_reasoning.trm@TinyRecursiveReasoningModel

  # Model architecture
  batch_size: 6144  # Will be overridden by global_batch_size
  seq_len: 81  # Sudoku sequence length
  vocab_size: 100  # Will be auto-detected from dataset
  num_puzzle_identifiers: 1000  # Will be auto-detected from dataset

  hidden_size: 512
  num_heads: 8
  expansion: 4.0
  num_layers: 2  # L_layers

  # Recursion
  H_cycles: 3
  L_cycles: 6

  # Position encodings
  pos_encodings: rope
  rope_theta: 10000.0
  rms_norm_eps: 1e-5

  # ACT halting
  halt_max_steps: 16
  halt_exploration_prob: 0.1
  no_ACT_continue: true

  # Puzzle embeddings
  puzzle_emb_ndim: 512  # Same as hidden_size
  puzzle_emb_len: 16
  mlp_t: false

  # Dtype
  dtype: bfloat16

# Data paths
data_paths:
  - data/sudoku-extreme-1k-aug-1000

data_paths_test: []

# Training hyperparameters
global_batch_size: 6144  # Total across all devices (768 per device for 8 devices)
epochs: 50000

# Evaluation
eval_interval: 5000
min_eval_interval: 0
checkpoint_every_eval: true
save_checkpoint_steps: 1000

# Optimizer
lr: 1e-4
lr_min_ratio: 1.0
lr_warmup_steps: 2000
beta1: 0.9
beta2: 0.95
weight_decay: 1.0
gradient_clip_norm: 1.0

# Puzzle embeddings
puzzle_emb_lr: 1e-4
puzzle_emb_weight_decay: 1.0

# Regularization
ema: true
ema_rate: 0.999
freeze_weights: false

# Reproducibility
seed: 0

# Logging
project_name: null  # Will be auto-generated
run_name: null  # Will be auto-generated
checkpoint_path: null  # Will be auto-generated
load_checkpoint: null

# Evaluation
eval_save_outputs: []

# JAX specific
use_tpu: true
num_workers: 8

# Hydra configuration
hydra:
  output_subdir: null
  run:
    dir: .
